# 别名处理改进文档

## 📋 问题描述

AI 模型在输出翻译结果时可能使用不同的语言别名，导致解析器无法正确识别和分类翻译内容。例如：

### 🔍 问题示例

**配置文件中定义的中文别名：**
```yaml
- code: zh
  aliases: ["chinese", "中文", "汉语", "zh-cn"]
```

**AI 可能的输出变体：**
```
原文: Hello world
中文: 你好世界        # ✅ 标准格式  
汉语: 你好世界        # ❌ 之前无法识别
Chinese: 你好世界     # ❌ 之前无法识别
zh-cn: 你好世界       # ❌ 之前无法识别
```

**之前的问题：**
- 只有 "中文:" 能被正确识别并转换为 `zh` 键
- 其他别名会被忽略，导致 `translations` 字段缺失内容

## 🎯 解决方案

### 1. 动态 OutputRules 生成

**之前：硬编码规则**
```go
OutputSection{
    Key: "中文",
    Aliases: []string{"Chinese", "中文", "汉语"}, // 有限的别名
    LanguageCode: "zh",
}
```

**现在：动态生成**
```go
func (e *Engine) buildDynamicOutputRules(targetLanguageCodes []string) OutputRules {
    // 为每个目标语言动态创建OutputSection
    for _, langCode := range targetLanguageCodes {
        if lang, ok := e.languages[langCode]; ok {
            // 包含配置文件中的所有别名
            aliases := []string{}
            
            // 添加所有names中的值
            for _, name := range lang.Names {
                aliases = append(aliases, name)
            }
            
            // 添加配置文件中的所有别名
            aliases = append(aliases, lang.Aliases...)
            
            // 添加语言代码本身
            aliases = append(aliases, lang.Code, strings.ToUpper(lang.Code))
        }
    }
}
```

### 2. 双重匹配机制

**解析流程：**
```go
// 1. 首先尝试 OutputRules 匹配
for _, sectionRule := range rules.Sections {
    if matchFound {
        finalSections[sectionRule.LanguageCode] = value
        // ✅ 通过动态规则匹配成功
    }
}

// 2. 回退到通用语言识别
if !foundRule {
    if langCode, err := e.identifyLanguageFromText(keyFromLLM); err == nil {
        finalSections[langCode] = value
        // ✅ 通过回退机制匹配成功
    }
}
```

### 3. 通用语言识别

**支持的匹配类型：**
- **精确匹配**：`"中文"` → `zh`
- **别名匹配**：`"汉语"` → `zh`  
- **代码匹配**：`"zh-cn"` → `zh`
- **部分匹配**：`"英语翻译"` → `en`

## 📊 改进效果

### 现在支持的所有别名

**中文 (zh):**
- ✅ `中文` (display name)
- ✅ `Chinese` (english name)  
- ✅ `chinese` (alias)
- ✅ `汉语` (alias)
- ✅ `zh-cn` (alias)
- ✅ `zh` (code)
- ✅ `ZH` (upper code)

**英文 (en):**
- ✅ `英文` (display name)
- ✅ `English` (english name)
- ✅ `english` (alias)
- ✅ `英语` (alias)
- ✅ `en` (code)
- ✅ `EN` (upper code)

**繁体中文 (zh-hant):**
- ✅ `繁體中文` (display name)
- ✅ `Traditional Chinese` (english name)
- ✅ `zh-tw` (alias)
- ✅ `zh-hk` (alias)
- ✅ `traditional chinese` (alias)
- ✅ `繁体中文` (alias)
- ✅ `zh-hant` (code)

**日文 (ja):**
- ✅ `日文` (display name)
- ✅ `Japanese` (english name)
- ✅ `japanese` (alias)
- ✅ `日语` (alias)
- ✅ `日本語` (alias)
- ✅ `ja` (code)
- ✅ `JA` (upper code)

**韩文 (ko):**
- ✅ `韩文` (display name)
- ✅ `Korean` (english name)
- ✅ `korean` (alias)
- ✅ `韩语` (alias)
- ✅ `한국어` (alias)
- ✅ `ko` (code)
- ✅ `KO` (upper code)

**西班牙语 (es):**
- ✅ `西班牙语` (display name)
- ✅ `Spanish` (english name)
- ✅ `spanish` (alias)
- ✅ `español` (alias)
- ✅ `es` (code)
- ✅ `ES` (upper code)

**法语 (fr):**
- ✅ `法语` (display name)
- ✅ `French` (english name)
- ✅ `french` (alias)
- ✅ `français` (alias)
- ✅ `fr` (code)
- ✅ `FR` (upper code)

**德语 (de):**
- ✅ `德语` (display name)
- ✅ `German` (english name)
- ✅ `german` (alias)
- ✅ `deutsch` (alias)
- ✅ `de` (code)
- ✅ `DE` (upper code)

**俄语 (ru):** 🆕
- ✅ `俄语` (display name)
- ✅ `Russian` (english name)
- ✅ `russian` (alias)
- ✅ `俄文` (alias)
- ✅ `俄罗斯语` (alias)
- ✅ `Русский` (native name)
- ✅ `ru` (code)
- ✅ `RU` (upper code)

**意大利语 (it):** 🆕
- ✅ `意大利语` (display name)
- ✅ `Italian` (english name)
- ✅ `italian` (alias)
- ✅ `意大利文` (alias)
- ✅ `Italiano` (native name)
- ✅ `it` (code)
- ✅ `IT` (upper code)

### 测试案例

**输入示例：**
```
原文: Hello world
汉语: 你好世界
English: Hello world  
繁体中文: 你好世界
俄语: Привет мир
italian: Ciao mondo
```

**输出结果：**
```json
{
  "transcription": "Hello world",
  "translations": {
    "zh": "你好世界",        // ✅ "汉语" → "zh"
    "en": "Hello world",    // ✅ "English" → "en"  
    "zh-hant": "你好世界",  // ✅ "繁体中文" → "zh-hant"
    "ru": "Привет мир",     // ✅ "俄语" → "ru"
    "it": "Ciao mondo"      // ✅ "italian" → "it"
  }
}
```

### 实际测试验证

**1. 俄语翻译测试：**
```bash
curl -X POST -H "X-API-Key: dev-key-123" \
  -F "audio=@test.wav" \
  -F "task=translate" \
  -F "target_languages=ru" \
  http://localhost:8080/api/v1/process
```

**响应：**
```json
{
  "transcription": "亲爱的听众，你好，我现在是在用语音翻译。",
  "translations": {
    "ru": "Дорогие слушатели, здравствуйте, я сейчас использую голосовой переводчик."
  }
}
```

**2. 意大利语翻译测试：**
```bash
curl -X POST -H "X-API-Key: dev-key-123" \
  -F "audio=@test.wav" \
  -F "task=translate" \
  -F "target_languages=it" \
  http://localhost:8080/api/v1/process
```

**响应：**
```json
{
  "transcription": "嗯，亲爱的听众您好，我现在是在用语音翻译。",
  "translations": {
    "it": "Ehi, cari ascoltatori, sto usando la traduzione vocale."
  }
}
```

**3. 多语言组合测试：**
```bash
curl -X POST -H "X-API-Key: dev-key-123" \
  -F "audio=@test.wav" \
  -F "task=translate" \
  -F "target_languages=en,ru,it" \
  http://localhost:8080/api/v1/process
```

**响应：**
```json
{
  "transcription": "嗯，亲爱的听众您好，我现在是在用语音翻译。",
  "translations": {
    "en": "Hello, dear listeners, I am now using voice translation.",
    "ru": "Дорогие слушатели, я сейчас использую голосовой перевод.",
    "it": "Ciao, cari ascoltatori, sto usando ora il traduttore vocale."
  }
}
```

## 🔧 技术实现

### 关键改进点

1. **配置驱动**：所有别名都来自配置文件，不再硬编码
2. **动态生成**：根据请求的目标语言动态构建解析规则
3. **双重保险**：OutputRules + 回退机制确保不丢失任何翻译
4. **精确匹配**：改进的匹配算法优先选择最精确的匹配

### 配置文件示例

```yaml
prompt:
  languages:
    - code: zh
      names:
        display: "中文"
        english: "Chinese"
        native: "中文"
      aliases: ["chinese", "中文", "汉语", "zh-cn"]
    
    - code: en  
      names:
        display: "英文"
        english: "English"
        native: "English"
      aliases: ["english", "英文", "英语"]
```

### 日志监控

```json
{
  "level": "debug",
  "msg": "Converted LLM key to language code",
  "llmKey": "汉语",
  "finalKey": "zh", 
  "method": "outputrules"
}

{
  "level": "debug", 
  "msg": "Converted LLM key to language code using fallback",
  "llmKey": "zh-cn",
  "finalKey": "zh",
  "method": "fallback_language_identification"
}
```

## 🎉 总结

通过这个改进，系统现在能够：

1. **✅ 稳定识别**：无论AI输出什么别名，都能正确识别
2. **✅ 统一输出**：始终返回标准的语言代码作为键 (`zh`, `en`, `ja`, `ru`, `it` 等)
3. **✅ 配置驱动**：添加新语言或别名只需修改配置文件
4. **✅ 向后兼容**：不影响现有功能，纯增强
5. **✅ 监控友好**：详细的日志记录便于调试
6. **✅ 多语言支持**：现在支持 **10种语言**，包括新增的俄语🇷🇺和意大利语🇮🇹

### 📋 完整支持的语言列表

| 语言代码 | 显示名称 | 英文名称 | 原生名称 | 状态 |
|---------|---------|---------|---------|------|
| `zh` | 中文 | Chinese | 中文 | ✅ |
| `zh-hant` | 繁體中文 | Traditional Chinese | 繁體中文 | ✅ |
| `en` | 英文 | English | English | ✅ |
| `ja` | 日文 | Japanese | 日本語 | ✅ |
| `ko` | 韩文 | Korean | 한국어 | ✅ |
| `es` | 西班牙语 | Spanish | Español | ✅ |
| `fr` | 法语 | French | Français | ✅ |
| `de` | 德语 | German | Deutsch | ✅ |
| `ru` | 俄语 | Russian | Русский | 🆕 |
| `it` | 意大利语 | Italian | Italiano | 🆕 |

**核心价值：** 确保 `translations` 字段始终包含完整的翻译内容，提高API的稳定性和可靠性。现在支持更多语言，满足更广泛的国际化需求！ 